name: trajectory-attn

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      steps:
        required: false
        default: 300
      policy:
        required: false
        default: 'data/policies/attn'
      frame_size:
        required: false
        default: 300
      line_width:
        required: false
        default: 2

env:
  ALGOVIVO_REF: '97f924a7aa41378f0e132017b36c5a438c68e5e3'
  ALGOVIVO_BUILD_REF: 'cde2e06cb677672bf4da91987b2caf42a564748c'

jobs:
  generate-trajectory:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        agent: [biped, quadruped]
    steps:
      - name: Clone repo
        uses: actions/checkout@v4

      - name: Clone algovivo repo
        uses: actions/checkout@v4
        with:
          repository: 'juniorrojas/algovivo'
          ref: '${{ env.ALGOVIVO_REF }}'
          path: algovivo.repo
      
      - name: Clone algovivo build repo
        uses: actions/checkout@v4
        with:
          repository: 'juniorrojas/algovivo'
          ref: '${{ env.ALGOVIVO_BUILD_REF }}'
          path: algovivo.build.repo

      - name: Copy build files
        run: |
          cp -r algovivo.build.repo/build algovivo.repo/build

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install algovivo
        run: uv pip install --system "git+https://github.com/juniorrojas/algovivo.git@$ALGOVIVO_REF#subdirectory=utils/py"

      - name: Generate trajectory
        run: |
          export PYTHONPATH=.
          export ALGOVIVO_NATIVE_LIB_FILENAME=$(pwd)/algovivo.build.repo/build/native/algovivo.amd64.so
          python scripts/generate_trajectory_with_attn_policy.py \
            --agent data/agents/${{ matrix.agent }} \
            --steps ${{ github.event.inputs.steps || 30 }} \
            --policy ${{ github.event.inputs.policy || 'data/policies/attn' }}

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install ffmpeg

      - name: Render trajectory frames
        run: |
          cd algovivo.repo
          npm ci
          cd ..
          node algovivo.repo/utils/trajectory/renderTrajectory.js \
            --mesh trajectory_attn.out/mesh.json \
            --steps trajectory_attn.out/steps \
            --width ${{ github.event.inputs.frame_size || 300 }} \
            --height ${{ github.event.inputs.frame_size || 300 }}
      
      - name: Make video
        run: |
          ffmpeg \
            -framerate 30 \
            -i frames.out/%d.png \
            -c:v libx264 \
            -profile:v high \
            -crf 20 \
            -pix_fmt yuv420p \
            video_${{ matrix.agent }}.mp4

      - name: Upload trajectory data
        uses: actions/upload-artifact@v4
        with:
          path: trajectory_attn.out
          name: trajectory-${{ matrix.agent }}

      - name: Upload trajectory frames
        uses: actions/upload-artifact@v4
        with:
          path: frames.out
          name: trajectory-${{ matrix.agent }}-frames

      - name: Upload video
        uses: actions/upload-artifact@v4
        with:
          path: video_${{ matrix.agent }}.mp4
          name: trajectory-${{ matrix.agent }}-video

  merge-trajectories:
    runs-on: ubuntu-latest
    needs: generate-trajectory
    steps:
      - name: Download biped frames
        uses: actions/download-artifact@v4
        with:
          name: trajectory-biped-frames
          path: frames-biped

      - name: Download quadruped frames
        uses: actions/download-artifact@v4
        with:
          name: trajectory-quadruped-frames
          path: frames-quadruped

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install ffmpeg

      - name: Make video
        env:
          LINE_WIDTH: ${{ github.event.inputs.line_width || 2 }}
        run: |
          ffmpeg \
            -framerate 30 \
            -i "frames-biped/%d.png" \
            -framerate 30 \
            -i "frames-quadruped/%d.png" \
            -filter_complex "[0:v]pad=iw+${LINE_WIDTH}:color=black[left];[left][1:v]hstack=inputs=2" \
            -c:v libx264 \
            -profile:v high \
            -crf 20 \
            -pix_fmt yuv420p \
            -r 30 \
            -y \
            merged.mp4

      - name: Upload merged video
        uses: actions/upload-artifact@v4
        with:
          path: merged.mp4
          name: video